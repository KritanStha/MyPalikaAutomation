name: MyPalika Cypress Tests with Mochawesome Reporter

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "15 6 * * *" # Runs daily at 12:00 PM Nepali time (UTC+5:45 = 6:15 AM UTC)
  workflow_dispatch: # Allows manual trigger from GitHub UI

permissions:
  pull-requests: write
  contents: write

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      USER_EMAIL: ${{ secrets.USER_EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üß™ Run Cypress tests with Mochawesome Reporter
        run: |
          npx cypress run
        continue-on-error: true

      - name: üìä Generate Mochawesome HTML Report
        if: always()
        run: |
          npx mochawesome-merge cypress/reports/*.json > cypress/reports/mochawesome-bundle.json
          npx marge cypress/reports/mochawesome-bundle.json --reportDir cypress/reports --reportFilename index.html
        continue-on-error: true

      - name: üì§ Upload Mochawesome Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: MyPalika-Test-Report-${{ github.run_number }}
          path: cypress/reports/
          retention-days: 30

      - name: üìß Send Report via Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "MyPalika Test Report - Run #${{ github.run_number }} - ${{ job.status }}"
          body: |
            MyPalika Automation Test Report
            
            Workflow Run: #${{ github.run_number }}
            Status: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            
            Please find the attached HTML report from the latest test run.
            You can also download the full report from GitHub Actions artifacts.
          to: ${{ secrets.REPORT_EMAIL }}
          from: ${{ secrets.EMAIL_USERNAME }}
          attachments: cypress/reports/index.html

      - name: üí¨ Comment & ‚ùå Auto-close PR if tests failed
        if: failure() && github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚ùå Cypress tests failed. This PR is being closed automatically. Please review the test report and fix the issues."
          gh pr close ${{ github.event.pull_request.number }}
        continue-on-error: true

      - name: ‚úÖ Auto-merge PR if tests passed
        if: success() && github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Merging PR #${{ github.event.pull_request.number }}..."
          gh pr merge ${{ github.event.pull_request.number }} --merge --auto
          echo "PR #${{ github.event.pull_request.number }} merged successfully."
        continue-on-error: true
